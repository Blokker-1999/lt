#!/bin/sh

# Nightly build script.
# This script generates all the books for the download page on the website.
# (c) 2010 Serge van Ginderachter

# environment
wwwbooksdir=~/www/default/wp-content/blogs.dir/linux-training/files/books/
cd ~/src/lt
outputdir=./output
www=~/proj/wwwfiles
mkdir -v -p $www

# pull in latest buildfiles
CURRENT_REV=$(git show  | grep "^commit")
git pull -v
NEW_REV=$(git show  | grep "^commit")

# check if the version changed, if not just exit unless the force switch is on.
if [ "$CURRENT_REV" = "$NEW_REV" ]
then    echo "No updates."
        [ z$1 = z-f ] || exit 0
else    echo "Revision bumped from $CURRENT_REV to $NEW_REV."
fi

# fresh start
clean () {
        ./make.sh clean
        rm -rf $outputdir
}
clean

# LinuxFun
./make.sh html fundamentals
mkdir -p $www/html/
mv -v -T $outputdir/html $www/html/fun
./make.sh clean
mv -v $outputdir/*.pdf $www/LinuxFun.pdf
                  
# LinuxAdm
./make.sh build sysadmin
./make.sh clean
mv -v $outputdir/*.pdf $www/LinuxAdm.pdf

# LinuxSrv
./make.sh build advanced
./make.sh clean
mv -v $outputdir/*.pdf $www/LinuxSrv.pdf

# LinuxTraining
./make.sh build complete
./make.sh clean
mv -v $outputdir/*.pdf $www/LinuxTraining.pdf

# DataNet
#./cvomake.sh build cvo2010
#./make.sh clean
#mv -v $outputdir/*.pdf $www/DataNet.pdf
# No daily update for dataNet until 22/12/2010 at least, for now we maintain a fixed version.
cp lib/20101106-DataNet.pdf $www/DataNet.pdf

# cleanup
clean

rsync -v -a $www/ $wwwbooksdir/ --delete || exit 1

exit 0
}
