<section><title>changes in smb.conf</title>
	<section><title>workgroup</title>
		<para>The <command>workgroup</command> option in the global section should match the netbios name of the Active Directory domain.</para>
		<screen>
workgroup = STARGATE
		</screen>
	</section>
	<section><title>security mode</title>
		<para>Authentication will not be handled by samba now, but by the Active Directory domain controllers, so we set the <command>security</command> option to domain.</para>
		<screen>
security = Domain
		</screen>
	</section>
	<section><title>Linux uid's</title>
	<para>Linux requires a user account for every user accessing its file system, we need to provide Samba with a range of uid's and gid's that it can use to create these user accounts. The first Active Directory user to connect will receive Linux uid 20000.</para>
		<screen>
idmap uid = 20000-22000
idmap gid = 20000-22000
		</screen>
	</section>
	<section><title>[global] section in smb.conf</title>
		<para>Below is our new global section in smb.conf.</para>
		<screen>
[global]
 workgroup = STARGATE
 security = Domain
 server string = Stargate Domain Member Server
 idmap uid = 20000-22000
 idmap gid = 20000-22000
		</screen>
	</section>
	<section><title>[share] section</title>
		<para>Nothing special is required for the share section in smb.conf. Remember that we do not manually create users in smbpasswd or on the Linux (/etc/passwd). Only Active Directory users are allowed access.</para>
		<screen>
[domaindata]
 path = /srv/samba/domaindata
 comment = Active Directory users only
 read only = No
		</screen>
	</section>
</section>
<section><title>joining an Active Directory domain</title>
	<para>While the Samba server is stopped, you can use <command>net rpc join</command><indexterm><primary>net rpc join(samba)</primary></indexterm> to join the Active Directory domain.</para>
	<screen>
[root@RHEL52 samba]# service smb stop
Shutting down SMB services:                                [  OK  ]
Shutting down NMB services:                                [  OK  ]
[root@RHEL52 samba]# net rpc join -U Administrator
Password:
Joined domain STARGATE.
	</screen>
	<para>We can verify in the aduc (Active Directory Users and Computers) that a computer account is created for this samba server.</para>
	<mediaobject><imageobject><imagedata fileref="images/sambacomputeraccount.jpg" format="EPS" align="center"></imagedata></imageobject></mediaobject>			
</section>
<section><title>winbind</title>
	<section><title>adding winbind to nsswitch.conf</title>
		<para>The <command>winbind daemon</command><indexterm><primary>winbind(8)</primary></indexterm> is talking with the Active Directory domain.</para>
		<para>We need to update the <command>/etc/nsswitch.conf</command><indexterm><primary>/etc/nsswitch.conf</primary></indexterm> file now, so user group and host names can be resolved against the winbind daemon.</para>
		<screen>
[root@RHEL52 samba]# vi /etc/nsswitch.conf 
[root@RHEL52 samba]# grep winbind /etc/nsswitch.conf 
passwd:     files winbind
group:      files winbind
hosts:      files dns winbind
		</screen>
	</section>
	<section><title>starting samba and winbindd</title>
		<para>Time to start Samba followed by <command>winbindd</command><indexterm><primary>winbindd(8)</primary></indexterm>.</para>
		<screen>
[root@RHEL4b samba]# service smb start
Starting SMB services:                                     [  OK  ]
Starting NMB services:                                     [  OK  ]
[root@RHEL4b samba]# service winbind start
Starting winbindd services:                                [  OK  ]
[root@RHEL4b samba]# 
		</screen>
	</section>
</section>
<section><title>wbinfo</title>
	<section><title>user query</title>
		<para>We can use <command>wbinfo -a</command> to verify authentication of a user against Active Directory. Assuming a user account <command>harry</command> with password <command>stargate</command> is just created on the Active Directory, we get the following screenshot.</para>
		<screen>
[root@RHEL52 samba]# wbinfo -a harry%stargate
plaintext password authentication failed
error code was NT_STATUS_NO_SUCH_USER (0xc0000064)
error messsage was: No such user
Could not authenticate user harry%stargate with plaintext password
challenge/response password authentication succeeded
		</screen>
		<para>We can use <command>getent</command><indexterm><primary>getent(1)</primary></indexterm> to verify that winbindd is working and actually adding the Active directory users to /etc/passwd. The screenshot below shows that Kim and Serena are normal Linux users in /etc/passwd, and that the Active Directory user Venus received uid 20000 in /etc/passwd.</para>
		<screen>
[root@RHEL4b samba]# getent passwd Kim
Kim:x:504:504:Kim Clijsters:/home/Kim:/bin/bash
[root@RHEL4b samba]# getent passwd Serena
Serena:x:503:503:Serena Williams:/home/Serena:/bin/bash
[root@RHEL4b samba]# getent passwd Venus
venus:*:20000:20000::/home/PEGASUS/venus:/bin/false
		</screen>
		<para>Not all Active Directory user accounts added to /etc/passwd by winbindd, only those that have been used.</para>
		<screen>
[root@RHEL4b samba]# getent passwd Justine
[root@RHEL4b samba]# wbinfo -a Justine%JustineH
plaintext password authentication succeeded
challenge/response password authentication succeeded
[root@RHEL4b samba]# getent passwd Justine
justine:*:20001:20000::/home/PEGASUS/justine:/bin/false
[root@RHEL4b samba]#
		</screen>
		<para>All the Active Directory users can now easily connect to the Samba share. Files created by them, belong to them. </para>
		<screen>
[root@RHEL4b samba]# ll /srv/samba/domaindata/
total 0
-rwxr--r--  1 justine 20000 0 Jun 22 19:54 created_by_justine_on_winxp.txt
-rwxr--r--  1 venus   20000 0 Jun 22 19:55 created_by_venus.txt
-rwxr--r--  1 maria   20000 0 Jun 22 19:57 Maria.txt
		</screen>
	</section>
</section>
